<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Dungeon Master</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d1b3d 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        .panel {
            background: rgba(30, 30, 46, 0.8);
            border: 2px solid #4a4a6a;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        h1, h2 {
            color: #ff6b6b;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online { background: #51cf66; }
        .status-offline { background: #ff6b6b; }
        .game-state {
            background: rgba(74, 74, 106, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .game-state-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-player {
            background: rgba(81, 207, 102, 0.2);
            border-left: 3px solid #51cf66;
        }
        .message-dm {
            background: rgba(255, 107, 107, 0.2);
            border-left: 3px solid #ff6b6b;
        }
        .message-label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        input, select, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #4a4a6a;
            border-radius: 6px;
            background: rgba(30, 30, 46, 0.8);
            color: #e0e0e0;
            font-size: 16px;
        }
        button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 107, 107, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        .dice-roller {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .dice-btn {
            padding: 15px;
            background: linear-gradient(135deg, #4a4a6a 0%, #3a3a5a 100%);
            border: 2px solid #6a6a8a;
        }
        .dice-result {
            text-align: center;
            padding: 20px;
            background: rgba(81, 207, 102, 0.2);
            border-radius: 8px;
            margin: 15px 0;
            font-size: 24px;
            font-weight: bold;
        }
        .natural-20 { background: rgba(255, 215, 0, 0.3); color: #ffd700; }
        .natural-1 { background: rgba(255, 0, 0, 0.3); color: #ff6b6b; }
        .loading {
            text-align: center;
            padding: 20px;
            color: #ff6b6b;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 107, 107, 0.3);
            border-radius: 50%;
            border-top-color: #ff6b6b;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel: Controls -->
        <div>
            <div class="panel">
                <h1>ðŸŽ² AI Dungeon Master</h1>
                <div>
                    <span class="status-indicator" id="status-indicator"></span>
                    <span id="status-text">Checking...</span>
                </div>
            </div>

            <div class="panel">
                <h2>Game State</h2>
                <div class="game-state">
                    <div class="game-state-item">
                        <span>Phase:</span>
                        <span id="current-phase">Loading...</span>
                    </div>
                    <div class="game-state-item">
                        <span>Level:</span>
                        <span id="party-level">1</span>
                    </div>
                    <div class="game-state-item">
                        <span>Location:</span>
                        <span id="location">Unknown</span>
                    </div>
                    <div class="game-state-item">
                        <span>Combat:</span>
                        <span id="combat-status">No</span>
                    </div>
                </div>
                <button onclick="updateState()">Update State</button>
            </div>

            <div class="panel">
                <h2>Dice Roller</h2>
                <div class="dice-roller">
                    <button class="dice-btn" onclick="rollDice('d4')">d4</button>
                    <button class="dice-btn" onclick="rollDice('d6')">d6</button>
                    <button class="dice-btn" onclick="rollDice('d8')">d8</button>
                    <button class="dice-btn" onclick="rollDice('d10')">d10</button>
                    <button class="dice-btn" onclick="rollDice('d12')">d12</button>
                    <button class="dice-btn" onclick="rollDice('d20')">d20</button>
                </div>
                <input type="text" id="custom-dice" placeholder="Custom (e.g., 2d6+3)">
                <button onclick="rollCustom()">Roll Custom</button>
                <div id="dice-result"></div>
            </div>
        </div>

        <!-- Right Panel: Chat -->
        <div class="panel">
            <h2>Ask the DM</h2>
            <div class="chat-container" id="chat-container"></div>
            <input type="text" id="query-input" placeholder="What do you want to do?" 
                   onkeypress="if(event.key==='Enter') askDM()">
            <button onclick="askDM()">Ask DM</button>
            <button onclick="clearHistory()" style="background: #666; margin-top: 10px;">Clear History</button>
        </div>
    </div>

    <script>
        const socket = io();
        let isLoading = false;

        // Check status on load
        fetch('/api/status')
            .then(r => r.json())
            .then(data => {
                updateStatusIndicator(data.ollama_available);
                if (data.game_state) {
                    updateGameStateDisplay(data.game_state);
                }
            });

        function updateStatusIndicator(online) {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            if (online) {
                indicator.className = 'status-indicator status-online';
                text.textContent = 'AI Online';
            } else {
                indicator.className = 'status-indicator status-offline';
                text.textContent = 'AI Offline';
            }
        }

        function updateGameStateDisplay(state) {
            document.getElementById('current-phase').textContent = 
                state.phase.replace(/_/g, ' ').replace(/^\d+\s*/, '');
            document.getElementById('party-level').textContent = state.level;
            document.getElementById('location').textContent = state.location;
            document.getElementById('combat-status').textContent = state.combat ? 'Yes' : 'No';
        }

        async function askDM() {
            if (isLoading) return;
            
            const input = document.getElementById('query-input');
            const query = input.value.trim();
            if (!query) return;

            // Add player message
            addMessage(query, 'player');
            input.value = '';
            isLoading = true;

            // Show loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.innerHTML = '<div class="spinner"></div> DM is thinking...';
            document.getElementById('chat-container').appendChild(loadingDiv);

            try {
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query})
                });

                const data = await response.json();
                loadingDiv.remove();

                if (data.error) {
                    addMessage(`Error: ${data.error}`, 'dm');
                } else {
                    addMessage(data.response, 'dm');
                    if (data.routing) {
                        updateGameStateDisplay({
                            phase: data.routing.primary_phase,
                            level: document.getElementById('party-level').textContent,
                            location: document.getElementById('location').textContent,
                            combat: data.routing.query_type === 'combat'
                        });
                    }
                }
            } catch (error) {
                loadingDiv.remove();
                addMessage(`Error: ${error.message}`, 'dm');
            }

            isLoading = false;
        }

        function addMessage(text, type) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `message message-${type}`;
            div.innerHTML = `
                <div class="message-label">${type === 'player' ? 'ðŸŽ² Player' : 'ðŸŽ­ DM'}</div>
                <div>${text}</div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function rollDice(dice) {
            const response = await fetch('/api/dice/roll', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({dice})
            });
            const data = await response.json();
            displayDiceResult(data);
        }

        async function rollCustom() {
            const dice = document.getElementById('custom-dice').value;
            const response = await fetch('/api/dice/roll', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({dice})
            });
            const data = await response.json();
            displayDiceResult(data);
        }

        function displayDiceResult(data) {
            const resultDiv = document.getElementById('dice-result');
            let className = 'dice-result';
            if (data.natural_20) className += ' natural-20';
            if (data.natural_1) className += ' natural-1';
            
            resultDiv.className = className;
            resultDiv.innerHTML = `
                ${data.dice}: [${data.rolls.join(', ')}]
                ${data.modifier !== 0 ? ` ${data.modifier > 0 ? '+' : ''}${data.modifier}` : ''}
                = <strong>${data.total}</strong>
                ${data.natural_20 ? ' ðŸŒŸ NAT 20!' : ''}
                ${data.natural_1 ? ' ðŸ’€ NAT 1!' : ''}
            `;
        }

        function clearHistory() {
            if (confirm('Clear all chat history?')) {
                fetch('/api/history/clear', {method: 'POST'})
                    .then(() => {
                        document.getElementById('chat-container').innerHTML = '';
                    });
            }
        }

        // Socket.IO events
        socket.on('dm_response', (data) => {
            // Real-time updates from other clients
        });

        socket.on('dice_rolled', (data) => {
            displayDiceResult(data);
        });

        socket.on('state_updated', (data) => {
            updateGameStateDisplay(data);
        });
    </script>
</body>
</html>