<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session {{ context.campaign.session_number }} - {{ context.campaign.name }}</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/active_campaign.css') }}">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>

<body>
    <div class="container container-full">
        <div class="phase-header">
            <h1> {{ context.campaign.name }}</h1>
            <div class="session-info">
                <div>
                    <span class="phase-badge phase-active">Session {{ context.campaign.session_number }}</span>
                </div>
                <button onclick="endSession()" style="width: auto; padding: 8px 20px; background: linear-gradient(135deg, #e600ff 0%, #7B1FA2 100%);">
                    End Session
                </button>
            </div>
        </div>
        
        <div class="content">
            <!-- Left Sidebar: Party -->
             <div>

                
                {% if context.preparations_content %}
                <div class="panel">
                    <h2>ğŸ¯ Quest Setup</h2>
                    <div style="font-size: 0.85em; color: #b0b0b0; line-height: 1.6;">
                        <div class="quest-detail">
                            <details open>
                                <summary>ğŸ“– Quest Hook</summary>
                                <div class="quest-detail-content" id="quest-hook">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </details>
                        </div>
                        
                        <div class="quest-detail">
                            <details open>
                                <summary>ğŸ¯ Objective</summary>
                                <div class="quest-detail-content" id="quest-objective">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </details>
                        </div>
                        
                        <div class="quest-detail">
                            <details>
                                <summary>ğŸ“ Location</summary>
                                <div class="quest-detail-content" id="quest-location">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </details>
                        </div>
                        
                        <div class="quest-detail">
                            <details>
                                <summary>ğŸ‘¤ Key NPCs</summary>
                                <div class="quest-detail-content" id="quest-npcs">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </details>
                        </div>
                        
                        <button onclick="toggleFullQuestDetails()" style="margin-top: 12px; padding: 6px 12px; font-size: 0.8em; width: 100%;">
                            View Full Quest Details
                        </button>
                    </div>
                </div>
                {% endif %}
                
                 <div class="panel">
                    <h2>âš¡ Quick Actions</h2>
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="quickAction('I attack')"> Attack</button>
                        <button class="quick-btn" onclick="quickAction('I cast a spell')">âœ¨ Cast Spell</button>
                        <button class="quick-btn" onclick="quickAction('I search the room')">ğŸ” Search</button>
                        <button class="quick-btn" onclick="quickAction('I investigate')">ğŸ“– Investigate</button>
                        <button class="quick-btn" onclick="quickAction('I try to persuade')">ğŸ’¬ Persuade</button>
                        <button class="quick-btn" onclick="quickAction('I take a rest')">ğŸ›Œ Rest</button>
                    </div>
                </div>

            </div>
           
            <!-- Center: Main Chat -->
             
            <div>
                <div class="panel">
                    <h2>ğŸ“ Current Context</h2>
                    <div style="font-size: 0.9em; color: #b0b0b0;">
                        <p><strong>Phase:</strong> {{ context.phase_info.name }}</p>
                        <p><strong>Location:</strong> <span id="current-location">Unknown</span></p>
                        <p><strong>Combat:</strong> <span id="combat-status">No</span></p>
                    </div>
                </div>
                <div class="panel">
                    <h2>ğŸ­ Adventure Log</h2>
                    <div class="chat-container" id="chat-container"></div>
                    <textarea id="action-input" placeholder="What do you do?" rows="3"></textarea>
                    <button onclick="takeAction()" id="action-btn" style="margin-bottom: 10%;">Take Action</button>
                </div>
            </div>
            
            <!-- Right Sidebar: Combat & Tools -->

            
            <div>
                <div class="panel">
                    <h2>ğŸ‘¥ Party</h2>
                    {% for char in context.characters %}
                    {% set max_hp_safe = char.max_hp if char.max_hp and char.max_hp > 0 else 1 %}
                    {% set hp_pct = ((char.hp / max_hp_safe) * 100)|int %}
                    <div class="character-card">
                        <div class="char-name">{{ char.name }}</div>
                        <div class="char-stats">
                            <div>{{ char.race }} {{ char.char_class }}</div>
                            <div>Level {{ char.level }}</div>
                            <div>HP: {{ char.hp }}/{{ char.max_hp }}</div>
                            <div>AC: {{ char.ac }}</div>
                        </div>
                        <div class="hp-bar">
                            <div class="hp-fill" data-hp-pct="{{ hp_pct }}"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="panel">
                    <h2> Dice Roller</h2>
                    <div class="dice-grid">
                        <button class="dice-btn" onclick="roll('d4')">d4</button>
                        <button class="dice-btn" onclick="roll('d6')">d6</button>
                        <button class="dice-btn" onclick="roll('d8')">d8</button>
                        <button class="dice-btn" onclick="roll('d10')">d10</button>
                        <button class="dice-btn" onclick="roll('d12')">d12</button>
                        <button class="dice-btn" onclick="roll('d20')">d20</button>
                    </div>
                    <input type="text" id="custom-dice" placeholder="2d6+3">
                    <button onclick="rollCustom()">Roll Custom</button>
                    <div id="dice-result"></div>
                </div>
                
               

            </div>
          
        </div>
    </div>
    
    <!-- Quest Details Modal -->
    <div id="quest-modal" class="quest-modal">
        <div class="quest-modal-content">
            <span class="quest-modal-close" onclick="closeQuestModal()">&times;</span>
            <h2>ğŸ¯ Complete Quest Setup</h2>
            <div id="full-quest-content" style="margin-top: 20px;">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <div class="bottom-search-panel" id="bottom-search">
    <h2>
        ğŸ” SRD Quick Search
        <span class="search-toggle" onclick="toggleBottomSearch()">
            <span id="search-toggle-text">â–¼ Collapse</span>
        </span>
    </h2>
    
    <div class="search-content" id="search-content">
        <div class="search-input-area">
            <div class="search-main-input">
                <input type="text" 
                       id="srd-search-input" 
                       placeholder="Search rules, spells, monsters, items..."
                       onkeypress="if(event.key==='Enter') searchSRD()">
                <button onclick="searchSRD()">Search</button>
            </div>
            
            <div class="quick-searches-horizontal">
                <button class="quick-search-btn-small" onclick="quickSearchSRD('fireball')">ğŸ”¥ Fireball</button>
                <button class="quick-search-btn-small" onclick="quickSearchSRD('grapple')">ğŸ¤¼ Grapple</button>
                <button class="quick-search-btn-small" onclick="quickSearchSRD('opportunity attack')"> Opportunity</button>
                <button class="quick-search-btn-small" onclick="quickSearchSRD('conditions')">ğŸ­ Conditions</button>
                <button class="quick-search-btn-small" onclick="quickSearchSRD('cover')">ğŸ›¡ï¸ Cover</button>
                <button class="quick-search-btn-small" onclick="quickSearchSRD('death saving throw')">ğŸ’€ Death Saves</button>
                <button class="quick-search-btn-small" onclick="quickSearchSRD('concentration')">ğŸ§  Concentration</button>
                <button class="quick-search-btn-small" onclick="quickSearchSRD('stealth')">ğŸ‘ï¸ Stealth</button>
            </div>
        </div>
        
        <div class="search-results-bottom" id="srd-results">
            <div style="text-align: center; color: #888; padding: 20px; font-size: 0.9em;">
                Enter search or click quick button
            </div>
        </div>
    </div>
</div>

</div>


    <script>
    // Pass server-side data to JavaScript
    window.campaignData = {
        sessionNumber: {{ context.campaign.session_number }},
        campaignName: "{{ context.campaign.name }}",
        preparationsContent: {{ context.preparations_content | default('null') | tojson | safe }},
        isFirstSession: {{ 'true' if context.campaign.session_number == 1 else 'false' }}
    };
</script>

    <script src="{{ url_for('static', filename='js/active_campaign.js') }}"></script>
</body>
</html>